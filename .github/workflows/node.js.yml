name: Node.js CI with MongoDB

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: üîß Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üõ† Debug MongoDB Service
        run: |
          docker ps -a
          sudo journalctl -u mongod --no-pager || echo "No MongoDB logs found"
          sudo systemctl status mongod || echo "MongoDB service not found"

      - name: üîç Install MongoDB Shell
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -
          echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-org-shell
          
          # Ensure mongosh is in PATH
          echo "export PATH=/usr/bin:$PATH" >> ~/.bashrc
          source ~/.bashrc
          
          # Verify mongosh installation
          which mongosh
          ls -lah /usr/bin/mongosh

      - name: üîÑ Ensure MongoDB is Running
        run: |
          sudo systemctl start mongod || sudo service mongod start
          sleep 5
          mongosh --host localhost --eval "db.runCommand({ ping: 1 })"

      - name: üõ†Ô∏è Run Code Checks (ESLint + Tests)
        run: ./checkmycode.sh
